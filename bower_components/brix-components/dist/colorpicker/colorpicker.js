define(["jquery","underscore","brix/base","brix/event","./colorpicker.tpl.js","css!./colorpicker.css"],function(t,e,o,s,i,r,c,d,n){function a(){}function l(t,e,o){var s,i,r,c,d;t=t%360/60,d=o*e,c=d*(1-Math.abs(t%2-1)),s=i=r=o-d,t=~~t,s+=[d,c,0,0,c,d][t],i+=[c,d,d,c,0,0][t],r+=[0,0,c,d,d,c][t];var n=255*s,a=255*i,l=255*r;return{r:n,g:a,b:l,hex:"#"+(16777216|l|a<<8|n<<16).toString(16).slice(1)}}function h(t,e,o){(t>1||e>1||o>1)&&(t/=255,e/=255,o/=255);var s,i,r,c;return r=Math.max(t,e,o),c=r-Math.min(t,e,o),s=0===c?null:r==t?(e-o)/c+(o>e?6:0):r==e?(o-t)/c+2:(t-e)/c+4,s=s%6*60,i=0===c?0:c/r,{h:s,s:i,v:r}}return r='            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%">                <defs>                    <linearGradient id="gradient-hsv" x1="0%" y1="100%" x2="0%" y2="0%">                        <stop offset="0%" stop-color="#FF0000" stop-opacity="1"></stop>                        <stop offset="13%" stop-color="#FF00FF" stop-opacity="1"></stop>                        <stop offset="25%" stop-color="#8000FF" stop-opacity="1"></stop>                        <stop offset="38%" stop-color="#0040FF" stop-opacity="1"></stop>                        <stop offset="50%" stop-color="#00FFFF" stop-opacity="1"></stop>                        <stop offset="63%" stop-color="#00FF40" stop-opacity="1"></stop>                        <stop offset="75%" stop-color="#0BED00" stop-opacity="1"></stop>                        <stop offset="88%" stop-color="#FFFF00" stop-opacity="1"></stop>                        <stop offset="100%" stop-color="#FF0000" stop-opacity="1"></stop>                    </linearGradient>                </defs>                <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient-hsv)"></rect>            </svg>        ',c='            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%">                <defs>                    <lineargradient id="gradient-black" x1="0%" y1="100%" x2="0%" y2="0%">                        <stop offset="0%" stop-color="#000000" stop-opacity="1"></stop>                        <stop offset="100%" stop-color="#CC9A81" stop-opacity="0"></stop>                    </lineargradient>                    <lineargradient id="gradient-white" x1="0%" y1="100%" x2="100%" y2="100%">                        <stop offset="0%" stop-color="#FFFFFF" stop-opacity="1"></stop>                        <stop offset="100%" stop-color="#CC9A81" stop-opacity="0"></stop>                    </lineargradient>                </defs>                <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient-white)"></rect>                <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient-black)"></rect>            </svg>        ',d='            <div style="position: relative; width: 100%; height: 100%">                <v:rect style="position: absolute; top: 0; left: 0; width: 100%; height: 100%" stroked="f" filled="t">                    <v:fill type="gradient" method="none" angle="0" color="red" color2="red" colors="8519f fuchsia;.25 #8000ff;24903f #0040ff;.5 aqua;41287f #00ff40;.75 #0bed00;57671f yellow"></v:fill>                </v:rect>            </div>        ',n='            <div style="position: relative; width: 100%; height: 100%">                <v:rect style="position: absolute; left: -1px; top: -1px; width: 101%; height: 101%" stroked="f" filled="t">                    <v:fill type="gradient" method="none" angle="270" color="#FFFFFF" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>                </v:rect>                <v:rect style="position: absolute; left: 0px; top: 0px; width: 100%; height: 101%" stroked="f" filled="t">                    <v:fill type="gradient" method="none" angle="0" color="#000000" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>                </v:rect>            </div>        ',e.extend(a.prototype,o.prototype,{options:{color:"#ffffff"},init:function(){},render:function(){var o=this,a=new s;this.color=this.options.color;var l=e.template(i)({colors:["#d81e06","#f4ea2a","#1afa29","#1296db","#13227a","#d4237a","#ffffff","#e6e6e6","#dbdbdb","#cdcdcd","#bfbfbf","#8a8a8a","#707070","#515151","#2c2c2c","#000000","#ea986c","#eeb174","#f3ca7e","#f9f28b","#c8db8c","#aad08f","#87c38f","#83c6c2","#7dc5eb","#87a7d6","#8992c8","#a686ba","#bd8cbb","#be8dbd","#e89abe","#e8989a","#e16632","#e98f36","#efb336","#f6ef37","#afcd51","#7cba59","#36ab60","#1baba8","#17ace3","#3f81c1","#4f68b0","#594d9c","#82529d","#a4579d","#db649b","#dd6572","#d81e06","#e0620d","#ea9518","#f4ea2a","#8cbb1a","#2ba515","#0e932e","#0c9890","#1295db","#0061b2","#0061b0","#004198","#122179","#88147f","#d3227b","#d6204b"],min:!1,color:this.color}),h=t(this.element),f=t(l).css({left:h.offset().left,top:h.offset().top+h.outerHeight()+1}).insertAfter(this.element).hide();this.relatedElement=f[0],this.pickerDragNode=f.find(".picker-indicator"),this.slideDragNode=f.find(".slide-indicator");var p=this.slideNode=f.find(".slide"),u=this.pickerNode=f.find(".picker"),g=window.SVGAngle||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML";switch(g){case"SVG":p.append(r),u.append(c);break;default:document.namespaces.v||document.namespaces.add("v","urn:schemas-microsoft-com:vml","#default#VML"),p.html(d),u.html(n)}this.setHex(this.color);var v="click.colorpicker_"+this.clientId;t(document.body).off(v).on(v,function(t){o.element!==t.target&&(f.has(t.target).length||o.hide())}),a.delegate(this.element,this),a.delegate(this.relatedElement,this),this.on("change selected",function(t,e){console.log(t.type,e)})},show:function(){t(this.relatedElement).show()},hide:function(){t(this.relatedElement).hide()},toggle:function(){var e=t(this.element);t(this.relatedElement).toggle().offset({left:e.offset().left,top:e.offset().top+e.outerHeight()+1})},setColor:function(e){var o=t(this.relatedElement);this.h=e.h%360,this.s=e.s,this.v=e.v;var s=l(this.h,this.s,this.v);this.slideDragNode.css({top:Math.round(this.h*this.slideNode.height()/360-5)});var i=Math.round(this.s*this.pickerNode.width()-5),r=Math.round((1-this.v)*this.pickerNode.height()-5);this.pickerDragNode.css({left:i,top:r,color:r>98?"#fff":"#000"}),this.pickerNode.css({"background-color":l(this.h,1,1).hex}),o.find(".colorpicker-footer span").css({"background-color":s.hex}),this.color=s.hex,o.find("li").removeClass("selected");var c=o.find("input");c.val()!==s.hex&&c.val(s.hex)},setHsv:function(t){this.setColor(t)},setRgb:function(t){this.setColor(h(t.r,t.g,t.b),t)},setHex:function(t){this.setColor(h(parseInt(t.substr(1,2),16),parseInt(t.substr(3,2),16),parseInt(t.substr(5,2),16)),void 0,t)},pickQuickColor:function(e,o){this.setHex(o),t(e.target).addClass("selected")},pickPaletteColor:function(t){var e=this.pickerNode.offset(),o=t.pageX-e.left,s=t.pageY-e.top,i=this.pickerNode.width(),r=this.pickerNode.height();this.setHsv({h:this.h,s:o/i,v:(r-s)/r})},dragPickerIndicator:function(e){var o=this;t(document.documentElement).css("cursor","pointer"),e.preventDefault(),t(document.body).on("mousemove.pickerDragNode",function(t){t.pageX-=5,t.pageY-=5;var e=o.pickerNode.offset(),s=o.pickerNode.width(),i=o.pickerNode.height(),r=t.pageX-e.left,c=t.pageY-e.top;r+5>s?r=s:0>r?r=0:r+=5,c+5>i?c=i:0>c?c=0:c+=5,o.setHsv({h:o.h,s:r/s,v:(i-c)/i})}).on("mouseup",function(){t(document.documentElement).css("cursor","auto"),t(document.body).off("mousemove.pickerDragNode")})},pickSlideColor:function(t){var e=this.slideNode.offset(),o=this.slideNode.height(),s=t.pageY-e.top>=o?o-1:t.pageY-e.top,i=s/o*360;this.setHsv({h:i,s:this.s,v:this.v})},dragSlideIndicator:function(e){var o=this;t(document.documentElement).css("cursor","pointer"),e.preventDefault(),t(document.body).on("mousemove.slideDragNode",function(t){t.pageX-=5,t.pageY-=5;var e=o.slideNode.offset(),s=o.slideNode.height(),i=t.pageY-e.top;i+5>s?i=s-1:0>i?i=0:i+=5,o.setHsv({h:i/o.slideNode.height()*360,s:o.s,v:o.v})}).on("mouseup",function(){t(document.documentElement).css("cursor","auto"),t(document.body).off("mousemove.slideDragNode")})},inputColor:function(e){var o=t(e.target).val();7===o.length&&this.color!==o&&this.setHex(o)},finishInputColor:function(e){var o=t(e.target).val();this.color!=o&&this.setHex(o)},submit:function(){var t=l(this.h,this.s,this.v);this.trigger("selected",{hex:t.hex,hsv:{h:this.h,s:this.s,v:this.v},rgb:{r:t.r,g:t.g,b:t.b}}),this.hide()}}),a});
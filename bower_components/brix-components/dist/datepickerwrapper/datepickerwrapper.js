define(["jquery","underscore","moment","brix/loader","components/base","brix/event","components/datepicker","../dialog/position.js","./datepickerwrapper.tpl.js"],function(t,e,i,n,a,s,r,o,c){function l(){}var p=/^input|textarea$/i,d=".datepickerwrapper",h=r.DATE_PATTERN,u=r.TIME_PATTERN,f=r.DATE_TIME_PATTERN,m=function(){var t=i(),e=t.get("date"),n={"今天":[i().startOf("day"),i().startOf("day")],"昨天":[i().startOf("day").subtract(1,"days"),i().startOf("day").subtract(1,"days")],"过去 7 天":[i().startOf("day").subtract(7,"days"),i().startOf("day").subtract(1,"days")],"本月":[i().startOf("day").subtract(e-1,"days"),i().startOf("day")],"上月":[i().startOf("day").subtract(1,"month").subtract(e-1,"days"),i().startOf("day").subtract(e,"days")],"最近 15 天":[i().startOf("day").subtract(15,"days"),i().startOf("day").subtract(1,"days")]};return n}(),g={PENDING:"pending",ACTIVE:"active",INACTIVE:"inactive"};return l.DATE_PATTERN=h,l.TIME_PATTERN=u,l.DATE_TIME_PATTERN=f,l.SHORTCUTS=m,e.extend(l.prototype,a.prototype,{options:{placement:"bottom",align:"left",offset:{},mode:"signal",shortcuts:m,type:"date",dates:[],ranges:[],unlimits:[]},init:function(){this.options.typeMap=r.typeMap(this.options.type),this.options.dates.length>1&&(this.options.mode="multiple"),this.options.dates.length||(this.options.dates=[i().startOf("day").format(h)]),this.options.shortcuts&&e.each(this.options.shortcuts,function(t){e.each(t,function(n,a){t[a]=i(n,e.isString(n)&&f)})}),this.options.range&&this.options.range.length&&(this.options.ranges=this.options.range),this.options.ranges=e.flatten(this.options.ranges||this.options.range),e.each(this.options.ranges,function(t,n,a){t&&(a[n]=i(t,e.isString(t)&&f))}),this.options._ranges=e.map(this.options.ranges,function(t){return t?t.format(h):void 0}),this.options._ranges="['"+this.options._ranges.join("','")+"']",c=this.options.template||c,this.options.css&&require("css!"+this.options.css)},render:function(){var i=this;this.$element=t(this.element),this.$relatedElement=t(e.template(c)(this.options)).insertAfter(this.$element),this["_"+this.options.mode]();var n="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(n).on(n,function(t){i.toggle(t)});var a=new s("bx-");a.delegate(this.$element,this),a.delegate(this.$relatedElement,this),this._autoHide()},val:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(e.each(i,function(i,n){i.val(e.isArray(t)?t[n]:t)}),this):e.map(i,function(t){return t.val()})},range:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(this.options.ranges=t=e.flatten(t),e.each(i,function(e){e.range(t)}),this):this.options.ranges},_signal:function(){var e=this;n.boot(this.$relatedElement,function(){var i=n.query("components/datepicker",e.$relatedElement)[0];i.on("change.datepicker unchange.datepicker",function(i,n,a){if(!n)return i.preventDefault(),void i.stopPropagation();if(!(void 0!==a&&"date"!==a&&"time"!==a||e.options.typeMap.time&&"date"===a)){e.hide();var s=t.Event("change"+d);if(e.trigger(s,[[n],a]),!s.isDefaultPrevented()){var r=p.test(e.element.nodeName),o=e._unlimitFilter(n,e.options.unlimits[0]);if(e.$element[r?"val":"html"](o),e.$element.triggerHandler("change"),!r){var c=t("[data-hidden-index]",e.$element);c.eq(0).val(o).triggerHandler("change")}}}}),i.$element.on("click",".timepicker .timepicker-footer .cancel",function(){e.hide()})})},_multiple:function(){var a=this;n.boot(this.$relatedElement,function(){var s=t(".datepickerwrapper-inputs",a.$relatedElement),r=t("input",s),o=t(".datepickerwrapper-pickers",a.$relatedElement),c=t(".picker",o),l=n.query("components/datepicker",a.$relatedElement),p=t(".datepickerwrapper-shortcuts",a.$relatedElement),d=t(".shortcut",p);a.options.shortcuts&&e.each(e.values(a.options.shortcuts),function(t,n){var s=!0;e.each(t,function(t,n){var r=i(a.options.dates[n],e.isString(a.options.dates[n])&&f);t.isSame(r,"days")||(s=!1)}),s&&d.eq(n).addClass("active").siblings().removeClass("active")}),e.each(r,function(n,s){t(n).val(i(a.options.dates[s],e.isString(a.options.dates[s])&&f).format(h))}),e.each(l,function(t,n){t.val(a.options.dates[n]).on("change.datepicker unchange.datepicker ",function(t,e,i){if(!(void 0!==i&&"date"!==i&&"time"!==i||a.options.typeMap.time&&"date"===i)){var s=a._unlimitFilter(e,a.options.unlimits[n]);r.eq(n).val(s),c.eq(n).hide()}});var s=a._unlimitFilter(i(a.options.dates[n],e.isString(a.options.dates[n])&&f),a.options.unlimits[n]);r.eq(n).val(s),t.$element.on("click",".timepicker .timepicker-footer .cancel",function(){c.eq(n).hide()})})})},_unlimitFilter:function(t,n){var a=this.options.typeMap,s=a.date&&a.time&&f||a.date&&h||a.time&&u,r=t.format(s);return n&&r===i(n,e.isString(n)&&f).format(s)&&(r="不限"),r},_inputToggleDatePicker:function(e,i,n){var a=t(".datepickerwrapper-inputs",this.$relatedElement),s=t(".datepickerwrapper-pickers",this.$relatedElement),r=t(".picker",s),o=a.offset();s.offset({left:o.left,top:o.top+a.outerHeight()+(parseInt(s.css("margin-top"),10)||0)});var c,l=r.eq(i),p=t(e.target),d=p.offset();switch(this.options.align){case"left":c=d.left;break;case"right":c=d.left-(l.outerWidth()-p.outerWidth())}l[n?n:"toggle"]().offset({left:c}).siblings().hide()},_hideDatePicker:function(){var e=t(".datepickerwrapper-pickers",this.$relatedElement),i=t(".picker",e);i.hide()},show:function(){this.$element.addClass("datepickerwrapper-open"),this.$relatedElement.show().offset(this._offset())},hide:function(){this.$element.removeClass("datepickerwrapper-open"),this._hideDatePicker(),this.$relatedElement.hide()},toggle:function(){this.$element.toggleClass("datepickerwrapper-open"),this.$relatedElement.toggle().offset(this._offset())},_offset:function(){var t=o(this.$element,this.$relatedElement,this.options.placement,this.options.align),e=parseInt(this.$relatedElement.css("margin-left"),10)||0,i=parseInt(this.$relatedElement.css("margin-top"),10)||0;return{left:t.left+e+(this.options.offset.left||0),top:t.top+i+(this.options.offset.top||0)}},submit:function(i,a){var s=this;switch(a){case"shortcut":break;default:var r=t(".datepickerwrapper-shortcuts",s.$relatedElement),o=t(".shortcut",r);o.removeClass("active")}var c=n.query("components/datepicker",this.$relatedElement),l=e.map(c,function(t){return t.val()});this.hide();var h=t.Event("change"+d);if(this.trigger(h,[l]),!h.isDefaultPrevented()){var u=t("[data-index]",this.$element);u.length?e.each(u,function(e,i){var n=t(e);i=+n.attr("data-index"),n[p.test(e.nodeName)?"val":"html"](s._unlimitFilter(l[i],s.options.unlimits[i]))}):this.$element[p.test(this.element.nodeName)?"val":"html"](e.map(l,function(t,e){return s._unlimitFilter(t,s.options.unlimits[e])}).join(", ")),u=t("[data-hidden-index]",this.$element),e.each(u,function(e,i){var n=t(e);i=+n.attr("data-hidden-index");var a=s._unlimitFilter(l[i],void 0);n.val(a).trigger("change")})}},shortcutText:function(t){var i;return e.each(this.options.shortcuts,function(n,a){if(!i){var s=!0;e.each(n,function(e,i){e.isSame(t[i],"days")||(s=!1)}),s&&(i=a)}}),i},_change:function(a,s,r){var o=this,c=t(a.target),l=n.query("components/datepicker",this.$relatedElement);switch(s){case"shortcut":var p=c.attr("data-value").split(",");e.each(p,function(t,e){o.options.dates[e]=t,l[e].val(t)}),c.addClass("active").siblings().removeClass("active"),this.submit(a,s);break;case"date":var d=i(c.val());if(!d.isValid())break;l[r].val(d)}},_autoHide:function(){var e=this,i="click"+d+"_"+this.clientId;this._state=g.INACTIVE,t(document.body).off(i).on(i,function(i){if(t.contains(document.body,i.target)){if(i.target===e.element||t.contains(e.element,i.target)||i.target===e.$relatedElement[0]||t.contains(e.$relatedElement[0],i.target)){if(e._state===g.ACTIVE)return;return e.trigger(t.Event("active"+d,{target:i.target})),void(e._state=g.ACTIVE)}if(e._state!==g.INACTIVE){var n=t.Event("inactive"+d,{target:i.target});e.trigger(n),e._state=g.INACTIVE,n.isDefaultPrevented()||e.hide()}}}).on(i,function(i){var n=t(".datepickerwrapper-inputs-body",e.$relatedElement),a=t(".datepickerwrapper-pickers",e.$relatedElement);i.target!==e.$relatedElement[0]&&!t.contains(e.$relatedElement[0],i.target)||!n.length||!a.length||t.contains(n[0],i.target)||t.contains(a[0],i.target)||e._hideDatePicker()})},destroy:function(){var t="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(t)}}),l});
define(["jquery","underscore","moment","brix/loader","components/base","brix/event","components/datepicker","../dialog/position.js","./datepickerwrapper.tpl.js"],function(t,e,i,n,a,s,r,o,l){function c(){}var d=/^input|textarea$/i,p=".datepickerwrapper",h=r.DATE_PATTERN,u=r.TIME_PATTERN,m=r.DATE_TIME_PATTERN,f=function(){var t=i(),e=t.get("date"),n={"今天":[i().startOf("day"),i().startOf("day")],"昨天":[i().startOf("day").subtract(1,"days"),i().startOf("day").subtract(1,"days")],"过去 7 天":[i().startOf("day").subtract(7,"days"),i().startOf("day").subtract(1,"days")],"本月":[i().startOf("day").subtract(e-1,"days"),i().startOf("day")],"上月":[i().startOf("day").startOf("month").subtract(1,"month"),i().startOf("day").startOf("month").subtract(1,"days")],"最近 15 天":[i().startOf("day").subtract(15,"days"),i().startOf("day").subtract(1,"days")]};return n}(),g={PENDING:"pending",ACTIVE:"active",INACTIVE:"inactive"};return c.DATE_PATTERN=h,c.TIME_PATTERN=u,c.DATE_TIME_PATTERN=m,c.SHORTCUTS=f,e.extend(c.prototype,a.prototype,{options:{placement:"bottom",align:"left",offset:{},mode:"signal",shortcuts:f,type:"date",dates:[],ranges:[],excludeds:[],unlimits:[]},init:function(){this.options.typeMap=r.typeMap(this.options.type),this.options.dates.length>1&&(this.options.mode="multiple"),this.options.dates.length||(this.options.dates=[i().startOf("day").format(h)]),this.options.shortcuts&&e.each(this.options.shortcuts,function(t){e.each(t,function(n,a){t[a]=i(n,e.isString(n)&&m)})}),this.options.range&&this.options.range.length&&(this.options.ranges=this.options.range),this.options.ranges=e.flatten(this.options.ranges||this.options.range),e.each(this.options.ranges,function(t,n,a){t&&(a[n]=i(t,e.isString(t)&&m))}),this.options._ranges=e.map(this.options.ranges,function(t){return t?t.format(h):void 0}),this.options._ranges="['"+this.options._ranges.join("','")+"']",this.options.excluded&&this.options.excluded.length&&(this.options.excludeds=this.options.excluded),this.options.excludeds=e.flatten(this.options.excludeds||this.options.excluded),e.each(this.options.excludeds,function(t,n,a){t&&(a[n]=i(t,e.isString(t)&&m))}),this.options._excludeds=e.map(this.options.excludeds,function(t){return t?t.format(h):void 0}),this.options._excludeds="['"+this.options._excludeds.join("','")+"']",l=this.options.template||l,this.options.css&&require("css!"+this.options.css)},render:function(){var i=this;this.$element=t(this.element),this.$relatedElement=t(e.template(l)(this.options)).insertAfter(this.$element);var n=t.Deferred();this["_"+this.options.mode](n);var a="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(a).on(a,function(t){i.toggle(t)});var r=this.$manager=new s("bx-");return r.delegate(this.$element,this),r.delegate(this.$relatedElement,this),this._autoHide(),n.promise()},val:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(e.each(i,function(i,n){i.val(e.isArray(t)?t[n]:t)}),this.submit(),this):e.map(i,function(t){return t.val()})},range:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(this.options.ranges=t=e.flatten(t),e.each(i,function(e){e.range(t)}),this):this.options.ranges},excluded:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(this.options.excludeds=t=e.flatten(t),e.each(i,function(e){e.excluded(t)}),this):this.options.excludeds},_signal:function(i){var a=this;n.boot(!0,this.$relatedElement,function(){var s=n.query("components/datepicker",a.$relatedElement)[0];s.on("change.datepicker unchange.datepicker",function(i,n,s){if(!n)return i.preventDefault(),void i.stopPropagation();if(!(void 0!==s&&"date"!==s&&"time"!==s||a.options.typeMap.time&&"date"===s)){a.hide();var r=t.Event("change"+p);if(a.trigger(r,[[n],s]),!r.isDefaultPrevented()){var o=a._unlimitFilter(n,a.options.unlimits[0]),l=t("[data-index]",a.$element);l.length?e.each(l,function(e,i){var n=t(e);n[d.test(e.nodeName)?"val":"html"](o)}):a.$element[d.test(a.element.nodeName)?"val":"html"](o),a.$element.triggerHandler("change"),d.test(a.element.nodeName)||t("[data-hidden-index]",a.$element).val(o).triggerHandler("change")}}}),s.$element.on("click",".timepicker .timepicker-footer .cancel",function(){a.hide()}),i&&i.resolve()})},_multiple:function(a){var s=this;n.boot(!0,this.$relatedElement,function(){var r=t(".datepickerwrapper-inputs",s.$relatedElement),o=t("input",r),l=t(".datepickerwrapper-pickers",s.$relatedElement),c=t(".picker",l),d=n.query("components/datepicker",s.$relatedElement),p=t(".datepickerwrapper-shortcuts",s.$relatedElement),u=t(".shortcut",p);s.options.shortcuts&&e.each(e.values(s.options.shortcuts),function(t,n){var a=!0;e.each(t,function(t,n){var r=i(s.options.dates[n],e.isString(s.options.dates[n])&&m);t.isSame(r,"days")||(a=!1)}),a&&u.eq(n).addClass("active").siblings().removeClass("active")}),e.each(o,function(n,a){t(n).val(i(s.options.dates[a],e.isString(s.options.dates[a])&&m).format(h))}),e.each(d,function(t,n){t.val(s.options.dates[n]).on("change.datepicker unchange.datepicker ",function(t,e,i){if(!(void 0!==i&&"date"!==i&&"time"!==i||s.options.typeMap.time&&"date"===i)){var a=s._unlimitFilter(e,s.options.unlimits[n]);o.eq(n).val(a),c.eq(n).hide()}});var a=s._unlimitFilter(i(s.options.dates[n],e.isString(s.options.dates[n])&&m),s.options.unlimits[n]);o.eq(n).val(a),t.$element.on("click",".timepicker .timepicker-footer .cancel",function(){c.eq(n).hide()})}),a&&a.resolve()})},_unlimitFilter:function(t,n){var a=this.options.typeMap,s=a.date&&a.time&&m||a.date&&h||a.time&&u,r=t.format(s);return n&&r===i(n,e.isString(n)&&m).format(s)&&(r="不限"),r},_inputToggleDatePicker:function(e,i,n){var a=t(".datepickerwrapper-inputs",this.$relatedElement),s=t(".datepickerwrapper-pickers",this.$relatedElement),r=t(".picker",s),o=a.offset();s.offset({left:o.left,top:o.top+a.outerHeight()+(parseInt(s.css("margin-top"),10)||0)});var l,c=r.eq(i),d=t(e.target),p=d.offset();switch(this.options.align){case"left":l=p.left;break;case"right":l=p.left-(c.outerWidth()-d.outerWidth())}c[n?n:"toggle"]().offset({left:l}).siblings().hide()},_hideDatePicker:function(){var e=t(".datepickerwrapper-pickers",this.$relatedElement),i=t(".picker",e);i.hide()},show:function(){this.$element.addClass("datepickerwrapper-open"),this.$relatedElement.show().offset(this._offset())},hide:function(){this.$element.removeClass("datepickerwrapper-open"),this._hideDatePicker(),this.$relatedElement.hide()},toggle:function(){this.$element.toggleClass("datepickerwrapper-open"),this.$relatedElement.toggle().offset(this._offset())},_offset:function(){var t=o(this.$element,this.$relatedElement,this.options.placement,this.options.align),e=parseInt(this.$relatedElement.css("margin-left"),10)||0,i=parseInt(this.$relatedElement.css("margin-top"),10)||0;return{left:t.left+e+(this.options.offset.left||0),top:t.top+i+(this.options.offset.top||0)}},submit:function(i,a){var s=this;switch(a){case"shortcut":break;default:var r=t(".datepickerwrapper-shortcuts",s.$relatedElement),o=t(".shortcut",r);o.removeClass("active")}var l=n.query("components/datepicker",this.$relatedElement),c=e.map(l,function(t){return t.val()});this.hide();var h=t.Event("change"+p);if(this.trigger(h,[c]),!h.isDefaultPrevented()){var u=t("[data-index]",this.$element);u.length?e.each(u,function(e,i){var n=t(e);i=+n.attr("data-index"),n[d.test(e.nodeName)?"val":"html"](s._unlimitFilter(c[i],s.options.unlimits[i]))}):this.$element[d.test(this.element.nodeName)?"val":"html"](e.map(c,function(t,e){return s._unlimitFilter(t,s.options.unlimits[e])}).join(", ")),u=t("[data-hidden-index]",this.$element),e.each(u,function(e,i){var n=t(e);i=+n.attr("data-hidden-index");var a=s._unlimitFilter(c[i],void 0);n.val(a).trigger("change")})}},shortcutText:function(t){var i;return e.each(this.options.shortcuts,function(n,a){if(!i){var s=!0;e.each(n,function(e,i){e.isSame(t[i],"days")||(s=!1)}),s&&(i=a)}}),i},_change:function(a,s,r){var o=this,l=t(a.target),c=n.query("components/datepicker",this.$relatedElement);switch(s){case"shortcut":var d=l.attr("data-value").split(",");e.each(d,function(t,e){o.options.dates[e]=t,c[e].val(t)}),l.addClass("active").siblings().removeClass("active"),this.submit(a,s);break;case"date":var p=i(l.val());if(!p.isValid())break;c[r].val(p)}},_autoHide:function(){var e=this,i="click"+p+"_"+this.clientId;this._state=g.INACTIVE,t(document.body).off(i).on(i,function(i){if(t.contains(document.body,i.target)){if(i.target===e.element||t.contains(e.element,i.target)||i.target===e.$relatedElement[0]||t.contains(e.$relatedElement[0],i.target)){if(e._state===g.ACTIVE)return;return e.trigger(t.Event("active"+p,{target:i.target})),void(e._state=g.ACTIVE)}if(e._state!==g.INACTIVE){var n=t.Event("inactive"+p,{target:i.target});e.trigger(n),e._state=g.INACTIVE,n.isDefaultPrevented()||e.hide()}}}).on(i,function(i){var n=t(".datepickerwrapper-inputs-body",e.$relatedElement),a=t(".datepickerwrapper-pickers",e.$relatedElement);i.target!==e.$relatedElement[0]&&!t.contains(e.$relatedElement[0],i.target)||!n.length||!a.length||t.contains(n[0],i.target)||t.contains(a[0],i.target)||e._hideDatePicker()})},destroy:function(){var e="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(e),this.$manager.undelegate(this.$element,this),this.$manager.undelegate(this.$relatedElement,this),this.$relatedElement.remove(),e="click"+p+"_"+this.clientId,t(document.body).off(e)}}),c});
define(["jquery","underscore","components/base","brix/event","./position.js","./dialog.tpl.js"],function(t,e,s,i,o,n){function l(){arguments.length&&(this.options=e.extend({},this.options,arguments[0]),this.init(),this.render()),c.push(this)}var h=150,a="swing",d=".dialog",r=[],c=[],p={PENDING:"pending",OPENED:"opened",CLOSED:"closed"};return e.extend(l.prototype,s.prototype,{options:{placement:"right",align:"top",left:void 0,top:void 0,width:"auto",height:"auto",offset:{left:0,top:0},className:"",content:"",closable:!0,movable:!1,modal:!1,singleton:!0},state:p.PENDING,init:function(){this.$element=t(this.element||this.options.element),this.$manager=new i("bx-"),this.options.css&&e.isString(this.options.css)&&require(["css!"+this.options.css]),this.options["class"]&&(this.options.className=this.options["class"]),-1===(""+this.options.content).indexOf("<")&&(this.options.content='<div class="dialog-body">'+this.options.content+"<div>")},render:function(){this.fill(),this.$manager.delegate(this.$element,this)},destroy:function(){this.close(),c=e.without(c,this);var s="keyup.dialog_autohide_"+this.clientId;r.length||t(document.body).off(s),this.$manager.undelegate(this.$element),this.$manager.undelegate(this.$relatedElement),this.$relatedElement.remove(),this.$relatedElement=null,this.$backdropElement=null},fill:function(){var s=e.template(n)(this.options);return this.$relatedElement||(this.$relatedElement=t(s).appendTo(document.body).hide()),this.options.singleton||this.$relatedElement.removeClass("dialog-singleton"),this.$relatedElement.find(".dialog-content").html(this.options.content),this.$relatedElement.css({width:this.options.width,height:this.options.height}),this.$backdropElement=t(".dialog-backdrop"),this.$backdropElement.length||(this.$backdropElement=t('<div class="dialog-backdrop"></div>').hide().appendTo(document.body)),this.options.modal,this.options.className&&this.$relatedElement.addClass(this.options.className),this.options.css&&e.isObject(this.options.css)&&this.$relatedElement.css(this.options.css),this.$manager.delegate(this.$relatedElement,this),this},open:function(){!this.element&&this.options.element&&this.options.element!==this.$element[0]&&(this.$element=t(this.options.element)),this.options.singleton&&e.each(r,function(t){t.options.singleton&&t.close()}),this.fill(),this._zIndex("open"),this._topmost(),this._move(),this.options.modal&&(t(document.body).addClass("modal-open"),this.$backdropElement.show().css("z-index",+this.$relatedElement.css("z-index")-1));var s=this._offset();return this.$relatedElement.show().stop().css(o.start(this.$relatedElement,s)).animate(o.end(this.$relatedElement,s),h,a),this._autoHide(),r.push(this),this.trigger("open"+d),this.state=p.OPENED,this},close:function(){if(!this.$relatedElement||!this.$relatedElement.length)return this;if(this.state===p.CLOSED)return this;var s=this,i=this._offset();if(this.$relatedElement.stop().animate(o.start(this.$relatedElement,i),h,a,function(){s.$relatedElement&&s.$relatedElement.hide()}),r=e.without(r,this),this.options.modal){var n=e.filter(r,function(t){return t.options.modal?t:void 0}).length;n||(t(document.body).removeClass("modal-open"),this.$backdropElement.hide())}return this._zIndex("close"),this.trigger("close"+d),this.state=p.CLOSED,this},_offset:function(){var t=void 0!==this.options.left&&void 0!==this.options.top?{left:this.options.left,top:this.options.top}:o(this.$element,this.$relatedElement,this.options.placement,this.options.align);return t={left:t.left+(this.options.offset.left||0),top:t.top+(this.options.offset.top||0)}},_autoHide:function(){var e="keyup.dialog_autohide_"+this.clientId;return t(document.body).off(e).on(e,function(t){if(27===t.keyCode){var e=r[r.length-1];e&&e.options.closable&&e.close()}}),this},_zIndex:function(t){if(r.length){var s,i=e.max(r,function(t){return+t.$relatedElement.css("z-index")}),o=+i.$relatedElement.css("z-index");switch(t){case"open":if(s=this,s===i)return;break;case"close":s=r[r.length-1]}return s.$backdropElement&&s.$backdropElement.css("z-index",o+1),s.$relatedElement.css("z-index",o+2),this}},_topmost:function(){var t=this,e="mousedown.dialog_topmost_"+this.clientId;return this.$relatedElement.off(e).on(e,function(){t._zIndex("open"),r.push(t)}),this},_move:function(){if(!this.options.movable)return this;var e=this,s="mousedown.dialog_move_"+this.clientId,i="mousemove.dialog_move_"+this.clientId,o="mouseup.dialog_move_"+this.clientId,n=t(document.body),l=this.$relatedElement.find(".dialog-header");return l.addClass("cursor-move"),l.off(s).on(s,function(t){var s=l.offset(),h={left:t.pageX-s.left,top:t.pageY-s.top};n.on(i,function(t){return e.$relatedElement.offset({left:t.pageX-h.left,top:t.pageY-h.top}),!1}),n.on(o,function(){return n.off(i),n.off(o),!1})}),this}}),l.open=function(t){return new l(t).open()},l.close=function(){var t=r.pop();t&&t.close()},l.closeAll=function(){return e.each(r,function(t){t.close()}),this},l.destroy=function(){return e.each(c,function(t){t.destroy()}),this},l});
define(["jquery","underscore","brix/loader","components/base","brix/event","./dropdown.tpl.js"],function(e,t,i,n,a,o){function l(e){return e&&e.element&&"select"!==e.element.nodeName.toLowerCase()?new s(e):void 0}function s(){}var r=".dropdown",d=t.template(o);return t.extend(l.prototype,n.prototype,{options:{name:void 0,label:void 0,value:void 0,data:[],disabled:void 0,width:void 0,className:void 0,justify:!1,searchbox:!1,placeholder:"搜索关键词",_searchboxEvent:"keyup",popover:!1,_popoverWidth:""},init:function(){this.$element=e(this.element).hide(),this.$manager=new a("bx-");var t=this.options;t.data.length?(this._fixFlattenData(this.options.data),this._fillSelect()):t.data=this._parseDataFromSelect(this.$element),t.disabled=this.$element.prop("disabled"),void 0!==t.value&&this.$element.val(t.value+"");var i=this.$element.find("option:selected");t.label=e.trim(i.text()),t.value=i.attr("value"),t.name=this.$element.attr("name"),t.searchbox&&(t.searchbox===!0?t._searchboxEvent="keyup":(t._searchboxEvent=t.searchbox,t.searchbox=!0)),t.popover&&t.popover!==!0&&(t._popoverWidth=t.popover,t.popover=!0),this.options["class"]&&(this.options.className=this.options["class"])},render:function(){this.$relatedElement=e(d(this.options)).insertBefore(this.$element);var t=this.options.width;t&&(parseInt(t)==t&&(t+="px"),this.$relatedElement.css({width:t,"min-width":t})),this.options.className&&this.$relatedElement.addClass(this.options.className),this.options.justify&&this.$relatedElement.addClass("dropdown-justify"),this.$manager.delegate(this.$element,this),this.$manager.delegate(this.$relatedElement,this),this.options.popover&&i.boot(this.$relatedElement),this._autoHide()},toggle:function(){return this.$relatedElement.toggleClass("open"),this},show:function(){return this.$relatedElement.addClass("open"),this},hide:function(){return this.$relatedElement.removeClass("open"),this},val:function(i){var n=this,a=function(){var t=n.$relatedElement.find("ul.dropdown-menu > li.active > a"),i=t.attr("value");return void 0===i&&(i=e.trim(t.text())),i}();if(void 0===i)return a;var o;if(t.isObject(i)?o=i:t.each(this.options.data,function(e){e.children?t.each(e.children,function(e){e.value==i&&(o=e),e.selected=e.value==i}):(e.value==i&&(o=e),e.selected=e.value==i)}),o){if(this.$relatedElement.find("button.dropdown-toggle > span.dropdown-toggle-label").text(o.label),this.$element.val(o.value),this.$relatedElement.find("ul.dropdown-menu").find('li:has([value="'+a+'"])').removeClass("active").end().find('li:has([value="'+o.value+'"])').addClass("active"),""+o.value===a)return this;var l=e.Event("change"+r);return this.trigger(l,{name:this.options.name,label:o.label,value:o.value}),this.$element.triggerHandler("change"),this}},data:function(t){if(void 0===t)return this.options.data;this.options.data=this._fixFlattenData(t),this._fillSelect();var n=this.$relatedElement.find("ul.dropdown-menu"),a=e(d(this.options)).find("ul.dropdown-menu");return n.replaceWith(a),this.$manager.delegate(this.$relatedElement,this),this.options.popover&&i.boot(this.$relatedElement),this},select:function(t){var i=e(t.currentTarget),n=i.attr("value"),a=e.trim(i.text());this.val(void 0!==n?n:a),this.toggle()},search:function(t){if("keyup"===t.type){var i=t.keyCode;if(91===i||i>15&&19>i||i>=37&&40>=i)return;if("enter"===this.options._searchboxEvent&&13!==i)return}var n=e(t.target).val();this.trigger("search"+r,n)},filter:function(e,t){e.type&&(e=t,t=!1);var i=this.$relatedElement.find("ul.dropdown-menu li");e?(i.css("display","none"),i.filter(':contains("'+e+'")').show().css("display","list-item")):i.css("display","list-item"),t&&i.has('> a[value*="'+e+'"]').show()},_parseDataFromSelect:function(i){function n(e){return t.map(e,function(e){return a(e)})}function a(t){var i=e(t);return i.hasClass("divider")?"divider":{label:e.trim(i.text()),value:i.attr("value"),selected:i.prop("selected")}}var o=t.filter(i.children(),function(e){return/optgroup|option/i.test(e.nodeName)});return t.map(o,function(t){var i=e(t);return/optgroup/i.test(t.nodeName)?{label:i.attr("label"),children:n(i.children())}:a(t)})},_fixFlattenData:function(e){return t.map(e,function(e,i,n){return n[i]=t.isObject(e)?e:{label:e,value:e}})},_fillSelect:function(){function i(t){return e("<option>").attr("value",t.value).prop("selected",t.selected).text(t.label)}var n=this.$element.empty();t.each(this.options.data,function(a){if(a.children&&a.children.length){var o=e("<optgroup>").attr("label",a.label);t.each(a.children,function(e){i(e).appendTo(o)}),o.appendTo(n)}else i(a).appendTo(n)})},_responsive:function(){var t=e(window),i=this.$relatedElement,n=i.find("ul.dropdown-menu");e(window).on("scroll",function(){var e=i.offset(),a=e.top-t.scrollTop(),o=t.scrollTop()+t.height()-e.top-i.outerHeight(),l=o>=a?"button":"top";switch(l){case"button":n.css("max-height",a-10);break;case"top":n.css("max-height",o-10)}})},_autoHide:function(){var t=this,i="click.dropdown_autohide_"+this.clientId;e(document.body).off(i).on(i,function(e){t.$relatedElement.has(e.target).length||t.hide()})},destroy:function(){this.$manager.undelegate(this.$element,this),this.$manager.undelegate(this.$relatedElement,this),this.$relatedElement.remove();var t="click.dropdown_autohide_"+this.clientId;e(document.body).off(t)}}),t.extend(s.prototype,l.prototype,{init:function(){this.$element=e(this.element),this.$relatedElement=this.$element,this.$manager=new a("bx-"),this._fixFlattenData(this.options.data),this.options.name=this.$element.attr("name")},render:function(){void 0!==this.options.value&&this.val(this.options.value),this.$manager.delegate(this.$relatedElement,this),this._autoHide()},val:function(i){var n=this,a=function(){var t=n.$element.find("ul.dropdown-menu > li.active > a"),i=t.attr("value");return void 0===i&&(i=e.trim(t.text())),i}();if(void 0===i)return a;var o;return t.isObject(i)?o=i:t.each(n.$element.find("ul.dropdown-menu > li"),function(t){var a=e(t),l=a.find("> a"),s=l.attr("value"),r=e.trim(l.text());(void 0!==s&&s==i||void 0===s&&r==i)&&(o={name:n.options.name,label:r,value:void 0!==s?s:r})}),o?(this.$relatedElement.find("button.dropdown-toggle > span.dropdown-toggle-label").text(o.label),""+o.value===a?this:(this.$relatedElement.find("ul.dropdown-menu").find('li:has([value="'+a+'"])').removeClass("active").end().find('li:has([value="'+o.value+'"])').addClass("active"),this.trigger("change"+r,o),this)):void 0},data:function(t){if(void 0===t)return this.options.data;this.options.data=this._fixFlattenData(t);var i=this.$relatedElement.find("ul.dropdown-menu"),n=e(d(this.options)).find("ul.dropdown-menu");return i.replaceWith(n),this.$manager.delegate(this.$relatedElement,this),this}}),l});
define(["jquery","underscore","brix/base","css!./ellipsis.css"],function(t,e,i){var s="ellip",n="ellip-line";return i.extend({options:{lines:"auto"},init:function(){"auto"!==this.options.lines&&(this.options.lines=+this.options.lines),this.$element=t(this.element),this._text=this.$element.text(),this._height=this.$element.height(),this.$relatedElement=t('<span class="'+s+'" />').text(this._text),this.$element.empty().append(this.$relatedElement)},render:function(){if(1===this.options.lines)return void this.$relatedElement.addClass(n);if(!("auto"===this.options.lines&&this.$relatedElement.prop("scrollHeight")<=this._height)){var e=this.parseWords(this._text),i=this.parseStart(this.options.lines,e);this.update(e,i);var s=this,r="click.ellipsis_"+this.options.clientId;t(window).off(r).on(r,function(){s.render()})}},update:function(t,e){t[e]='<span class="'+n+'">'+t[e],t.push("</span>"),this.$relatedElement.html(t.join(""))},parseStart:function(t,i){var s=e.map(i,function(t){return"<span>"+t+"</span>"});return this.$relatedElement.html(s.join("")),s=this.$relatedElement.find("span"),"auto"===t?this.parseStartByHeight(s):this.parseStartByLines(s)},parseStartByLines:function(e){for(var i,s,n,r=0,h=0;h<e.length;h++)if(s=t(e[h]).position().top,s!==n&&(n=s,r+=1),r===this.options.lines){i=h;break}return i},parseStartByHeight:function(e){for(var i,s,n,r,h=0,o={},a=0;a<e.length;a++)if(s=t(e[a]).position().top,n=n||t(e[a]).height(),s!==r?(r=s,h+=1,o[h]=[e[a]]):o[h].push([e[a]]),s+n>this._height){i=a-o[h-1].length;break}return i},parseWords:function(e){return t.trim(e).split("")},resize:function(){var t=this;clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(function(){t.render()},100)}})});
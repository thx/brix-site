define(["jquery","underscore","components/base","../dialog/position.js","./suggest.tpl.js","./suggest.item.tpl.js"],function(t,e,i,n,s,o){function l(){}var r=".suggest",h=".input",a=".done",u=".internal";return e.extend(l.prototype,i.prototype,{options:{template:"",data:[]},init:function(){var e=t.Deferred(),i=[],n=this.options.template,s=this.options.css;return n&&i.push(n),s&&(0!==s.indexOf("css!")&&(s="css!"+s),i.push(s)),require(i,function(){n&&(o=arguments[0]),e.resolve()}),i.length?e.promise():void 0},render:function(){this.$element=t(this.element);var i=e.template(s)(this.options);this.$relatedElement=t(i).insertAfter(this.$element),this.$menu=this.$relatedElement.find(".dropdown-menu"),this._fill(this.options.data)._beautify(),this._bindEvent()},data:function(t){return t?(this.options.data=t,void this._fill(t)._beautify()):this.options.data},val:function(t){return void 0===t?this.$element.val():(this.$element.val(t),this)},open:function(){return this.$relatedElement.show(),this},close:function(){return this.$relatedElement.hide(),this},focus:function(){return this.$element.focus(),this},blur:function(){return this.$element.blur(),this},_bindEvent:function(){var e=this;this.$element.off("keyup"+r+u).on("keyup"+r+u,function(t){return e._handlerHooks[t.which]?void e._handler(t):void e._sos(t.target.value)}).off("click"+r+u).on("click"+r+u,function(t){e._sos(t.target.value)}),this.$relatedElement.off("click"+r+u).on("click"+r+u,".dropdown-menu > li",function(i){e._moveTo(t(i.currentTarget).index()),e._select()}),t(document.body).off("click"+r+"_"+this.clientId).on("click"+r+"_"+this.clientId,function(t){e.element!==t.target&&(e.$relatedElement.has(t.target).length||e.close())})},_sos:function(t){this.trigger("change"+r+h,t)},_handler:function(t){var e=this._items();this._handlerHooks[t.which].call(this,t,e.all,e.active,e.index)},_items:function(){var t=this.$menu.find("> li"),e=t.filter(".active"),i=t.index(e);return{all:t,active:e,index:i}},_handlerHooks:{38:function(t,e,i,n){this._moveTo(e,i,--n)},40:function(t,e,i,n){return this.$menu.is(":visible")?void this._moveTo(e,i,++n):void this._fill(this.options.data)._beautify()},13:function(t,e,i,n){this.$menu.is(":visible")&&this._select(e,i,n)},27:function(t,e,i,n){this.close()}},_select:function(e,i,n){if(!e){var s=this._items();e=s.items,i=s.active,n=s.index}var o=t.trim(i.text());this.$element.val(o);var l="change"+r+a,h=t.Event(l,{target:this.element});return this.trigger(h,o),this.close().focus(),this},_moveTo:function(t,e,i){if(!e&&!i){i=t;var n=this._items();t=n.all,e=n.active}return i=(i+t.length)%t.length,e.removeClass("active"),t.eq(i).addClass("active"),this},_beautify:function(){this.$relatedElement[this.options.data&&this.options.data.length?"show":"hide"]();var t=n(this.$element,this.$relatedElement,"bottom","left");return this.$relatedElement.offset(t),this},_fill:function(t){var i,n=this,s=this.val(),l=e.template(o),r=e.map(t,function(t,e){return i=l({data:n._highlight(t,s)}),"<li>"+i+"</li>"}).join("");return this.$menu.empty().html(r).find("> li:first-child").addClass("active"),this},_highlight:function(t,e){if(!e)return t;var i=new RegExp(e,"ig");return(""+t).replace(i,function(t){return'<span class="highlight">'+t+"</span>"})}}),l});
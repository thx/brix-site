define(["jquery","underscore","Sortable","brix/event","../dialog/position.js","./column-priority.tpl.js"],function(t,e,n,a,i,r){function o(a,i,r,o){var c=t(i[r.COLUMN.PRIORITY.TRIGGER]),h=i[r.COLUMN.PRIORITY.PLACEMENT]||"bottom",I=i[r.COLUMN.PRIORITY.ALIGN]||"right",m=t(a.element),N=d(r,m);s(c,N,h,I),p(a,c,N),l(r,m,c,N,o);var O=N.find(".queue .sortable-wrapper");return O.length&&n.create(O[0],{handle:".item-move",animation:150,onEnd:function(){var n={},a=N.find(".queue .sortable-wrapper .item");e.each(a,function(e,a){var i=t(e),o=i.data(r.COLUMN.ID);n[o]=a,i.attr("data-"+r.COLUMN.PRIORITY.INDEX,a)});var i=m.find("> thead th");e.each(i,function(e){var a=t(e),i=a.data(r.COLUMN.ID);void 0!==i&&a.attr("data-"+r.COLUMN.PRIORITY.INDEX,n[i])})}}),N.on("change"+v,"input:checkbox",function(e){var n=t(e.target),a=n.data(r.COLUMN.ID),i=n.prop("checked");N.find(".queue .sortable-wrapper .item").filter("[data-"+r.COLUMN.ID+'="'+a+'"]')[i?"slideDown":"slideUp"]("fast")}),{$relatedElement:N,toggle:function(){N.toggle()},show:function(){N.show()},hide:function(){N.hide()},fields:function(n){if(n){var a=N.find(".candidates input:checkbox"),i=N.find(".queue .sortable-wrapper .item"),d=[];return e.each(a,function(a){var o=t(a),c=o.data(r.COLUMN.FIELD),u=e.indexOf(n,c);o.prop("checked",-1!==u).triggerHandler("change"+v);var f=i.filter("[data-"+r.COLUMN.FIELD+'="'+c+'"]');-1===u?f.hide():(f.show(),d[u]=f)}),e.each(d,function(e,n){e&&(0===n?t(e).parent().prepend(e):d[n-1].after(e))}),u(r,m,N),o&&o(void 0,n),this}return f(r,N)}}}function d(n,a){var i=h(n,a),o=e.template(r)(i),d=t(o).insertAfter(a);return d}function c(t,e,n,a){var r=i(t,e,n,a),o=parseInt(e.css("margin-left"),10)||0,d=parseInt(e.css("margin-top"),10)||0;return{left:r.left+o,top:r.top+d}}function u(n,a,i){var r=i.find(".candidates input:checkbox");return e.each(r,function(e){var i=t(e),r=i.data(n.COLUMN.ID);if(void 0!==r){var o=i.prop("checked"),d=o?"show":"hide",c=a.find("> thead th[data-"+n.COLUMN.ID+'="'+r+'"]').attr("data-"+n.COLUMN.PRIORITY.STATE,d)[d]();a.find("> tbody td:nth-child("+(c.index()+1)+")").attr("data-"+n.COLUMN.PRIORITY.STATE,d)[d]()}}),f(n,i)}function f(n,a){var i=[],r=a.find(".queue .sortable-wrapper .item");return e.each(r,function(e){var a=t(e);"none"!==a.css("display")&&i.push(a.data(n.COLUMN.FIELD)||a.data(n.COLUMN.NAME))}),i}function s(e,n,a,i){e.on("click"+v,function(){return n.is(":visible")?(n.hide(),void t(document.body).removeClass("modal-open")):void n.show().offset(c(e,n,a,i))})}function l(t,e,n,i,r){var o=new a("bx-"),d={submit:function(n){var a=u(t,e,i);r&&r(n,a,n.currentTarget),i.hide()},cancel:function(){i.hide()},all:function(){i.find(".candidates input:checkbox").prop("checked",!0),i.find(".queue .sortable-wrapper .item").show()},clear:function(){i.find(".candidates input:checkbox").prop("checked",!1),i.find(".queue .sortable-wrapper .item").hide()}};o.delegate(i,d)}function p(e,n,a){var i="click"+v+"_"+e.clientId;t(document.body).off(i).on(i,function(e){!n[0]||e.target===n[0]||t.contains(n[0],e.target)||e.target===a[0]||t.contains(a[0],e.target)||(t(document.body).removeClass("modal-open"),a.hide())})}function h(n,a){var i=a.find("> thead th"),r=!1,o=[],d=[],c=e.map(i,function(e,a){var i=t(e),c=i.data(n.COLUMN.NAME);return c||(c=t.trim(i.text()),i.attr("data-"+n.COLUMN.NAME,c)),c?void 0===i.data(n.COLUMN.ID)?void(r?d:o).push({index:a,name:c}):(r=!0,{index:a,id:i.data(n.COLUMN.ID),name:c,field:i.data(n.COLUMN.FIELD)||c}):void 0});return c=e.filter(c,function(t){return!!t}),{Constant:n,candidates:c,leftImmovables:o,rightImmovables:d}}var v=".table_column_priority";return o.NAMESPACE=v,o});
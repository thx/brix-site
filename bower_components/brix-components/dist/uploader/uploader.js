define(["jquery","underscore","brix/loader","components/base"],function(e,t,n,r){function o(){return("token"+Math.random()).replace(/\D/g,"")}function i(){}var a='<input name="<%= name %>" type="file" class="uploader-ghost">',s="data-token",c="["+s+"]",p=".uploader";return i.burn=function(t){var n=e(t);n.replaceWith(n.clone(!0,!0).attr(s,o()).prop("clientId",n.prop("clientId")))},i.transports={iframe:function(n,r){var o=e.Deferred(),a="FILE_UPLOAD_IFRAME_",s='<iframe id="<%= id %>" name="<%= id %>" style="display: none;"></iframe>';r.target=a+t.uniqueId(),r.action=n.action,r.method="POST",r.enctype="multipart/form-data";var c=t.template(s)({id:r.target});return e(c).insertAfter(r).on("load",function(t){var n=t.target,r=e((n.contentWindow||n.contentDocument).document.body),a=r.find("#result"),s=e.trim(a.length?a.text():r.text());i.parseJSONResponse(s,function(e,t){e?o.reject(e):o.resolve(t)}),e(n).remove()}).on("error",function(e){o.reject(e)}),r.submit(),o.promise()},xhr:function(n,r,o){var a=e.Deferred(),s=new FormData;t.each(o.files,function(e){s.append(n.name,e)});var c=new XMLHttpRequest;return c.overrideMimeType("application/json"),c.open("post",n.action,!0),c.upload.onprogress=function(e){e.percent=Math.round(e.loaded/e.total*100),a.notify(e)},c.onload=function(){var e=c.responseText;i.parseJSONResponse(e,function(e,t){e?a.reject(e):a.resolve(t)})},c.onerror=function(e){a.reject(e)},c.onabort=function(){a.reject("canceled")},c.ontimeout=function(){a.reject("timeout")},c.send(s),a.promise()}},i.parseJSONResponse=function(e,t){try{t(void 0,JSON.parse(e))}catch(n){try{t(void 0,new Function("return "+e)())}catch(r){console.log(e),console.error(n.stack||n),console.error(r.stack||r),t(r,e)}}finally{}},i.readFileAsDataURL=function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsDataURL(e)},t.extend(i.prototype,r.prototype,{options:{action:"",name:"file",transport:"iframe",multiple:!0,accept:""},render:function(){this.$element=e(this.element),this.$element.parent().css("position","relative");var r=e(t.template(a)(this.options)).attr(s,o()).prop("clientId",this.options.clientId).prop("disabled",this.$element.prop("disabled")).insertAfter(this.$element).width(this.$element.outerWidth()).height(this.$element.outerHeight()).offset(this.$element.offset());this.options.multiple&&r.attr("multiple","multiple"),this.options.accept&&r.prop("accept",this.options.accept);var l=r[0].form;e(l).off("change"+p).on("change"+p,"input[type=file]"+c,function(t){var r=t.currentTarget,o=n.query(r)[0],a=e.Event("start"+p);o.trigger(a,[r.files]),a.isDefaultPrevented()||o.send(l,r).then(function(e){o.trigger("success"+p,[r.files,e])},function(e){o.trigger("error"+p,[r.files,e])},function(e){o.trigger("progress"+p,[r.files,e])}).always(function(){try{o.trigger("complete"+p,[r.files])}finally{i.burn(r)}})})},send:function(e,t){return i.transports[this.options.transport](this.options,e,t)}}),i});
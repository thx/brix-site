define(["jquery","underscore","brix/loader","components/base"],function(e,t,n,o){function r(){return("token"+Math.random()).replace(/\D/g,"")}function i(e,t){try{t(void 0,JSON.parse(e))}catch(n){try{t(void 0,new Function("return "+e)())}catch(o){console.log(e),console.error(o),t(o,e)}}finally{}}function a(){}var s='<input name="<%= name %>" type="file" class="uploader-ghost">',p="data-token",l="["+p+"]",c=".uploader",u=".isDefaultPrevented";return t.extend(a.prototype,o.prototype,{options:{action:"",name:"file",transport:"iframe",multiple:!0,accept:""},render:function(){this.$element=e(this.element),this.$element.parent().css("position","relative");var o=e(t.template(s)(this.options)).attr(p,r()).prop("clientId",this.options.clientId).prop("disabled",this.$element.prop("disabled")).insertAfter(this.$element).width(this.$element.outerWidth()).height(this.$element.outerHeight()).offset(this.$element.offset());this.options.multiple&&o.attr("multiple","multiple"),this.options.accept&&o.prop("accept",this.options.accept);var i=o[0].form;e(i).off("change"+c).on("change"+c,"input[type=file]"+l,function(e){var t,o=e.currentTarget,r=n.query(o);r.on("start"+c+u,function(e){t=e.isDefaultPrevented()}).trigger("start"+c,[o.files]).off("start"+c+u),t||r.send(i,o,function(e,t){e?r.trigger("error"+c,[o.files,e]):r.trigger("success"+c,[o.files,t]),r.trigger("complete"+c,[o.files])})})},send:function(e,t,n){var o=this;this.transports[this.options.transport](this.options,e,t,function(e,r){n(e,r),o.burn(t)})},burn:function(t){var n=e(t);n.replaceWith(n.clone(!0,!0).attr(p,r()).prop("clientId",this.options.clientId))},transports:{iframe:function(n,o,r,a){var s="FILE_UPLOAD_IFRAME_",p='<iframe id="<%= id %>" name="<%= id %>" style="display: none;"></iframe>';o.target=s+t.uniqueId(),o.action=n.action,o.method="POST",o.enctype="multipart/form-data";var l=t.template(p)({id:o.target});e(l).insertAfter(o).on("load",function(t){var n=t.target,o=e.trim(e(n.contentWindow.document.body).text());i(o,a),e(n).remove()}).on("error",function(e){a(e,void 0)}),o.submit()},xhr:function(e,n,o,r){var a=new FormData;t.each(o.files,function(t){a.append(e.name,t)});var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("post",e.action,!0),s.upload.onprogress=function(){},s.onerror=function(e){console.error(e)},s.onload=function(){var e=s.responseText;i(e,r)},s.send(a)}},previewInConsole:function(n){if(n.length){var o=this;return void t.each(n,function(e){o.previewInConsole(e)})}var r=new FileReader;r.onload=function(o){var r=e("<img>").attr("src",o.target.result).attr("title",n.name).hide().appendTo("body"),i=r.width(),a=r.height(),s=t.template('padding: <%=pt%>px <%=pr%>px <%=pb%>px <%=pl%>px; line-height: <%=height%>px; background:url("<%=result%>") no-repeat center center;')({pt:a/2,pr:i/2,pb:a/2,pl:i/2,height:a+10,result:o.target.result});console.group(n.name),console.log("%c",s),console.log(n.size+" byte"),console.groupEnd(n.name),r.remove()},r.readAsDataURL(n)},previewAsComponent:function(t,n){var o=new FileReader;o.onload=function(o){var r=e("<img>").addClass("uploader-preview-thumbnail").attr("src",o.target.result).attr("title",t.name);n&&n(void 0,r)},o.readAsDataURL(t)}}),a});